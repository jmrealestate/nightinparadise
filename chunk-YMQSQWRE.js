import{a as _,b as H,c as K,d as C}from"./chunk-WUGOVNDJ.js";import{a as L}from"./chunk-CFCMLOOB.js";import{b as I}from"./chunk-JWZPFOXC.js";import{a as j}from"./chunk-Q7PONYZL.js";import"./chunk-6CYPE36V.js";import"./chunk-BPNGRFUY.js";import{a as O}from"./chunk-ONICS2XY.js";import{a as N}from"./chunk-5ML3MIDN.js";import{Ba as U,Y as D,ja as P,oa as G,sa as M}from"./chunk-32GEDFAZ.js";import{$c as E,Cb as p,Da as F,Ib as g,L as v,Nb as y,Ob as h,Pb as c,Yb as b,fb as m,ia as s,m as k,ma as R,oc as Y,pc as A,qb as u,qc as T,rc as w,t as S,u as f,xb as x,yc as $,zc as B}from"./chunk-OWBIYIKH.js";var q=i=>({text:i,tag:"h3"}),W=()=>({text:"Summary",tag:"h4"});function z(i,a){if(i&1&&c(0,"ks-basic-grid",4),i&2){let d=b();p("config",d.summaryGridConfig)("refresh$",d.summaryGridRefresh)}}function J(i,a){if(i&1&&c(0,"div",5),i&2){let d=b();p("chart",d.combinedChart)}}var he=(()=>{let a=class a{constructor(){this._destroyRef=s(F),this._dialog=s(P),this._navService=s(O),this._excelService=s(C),this._snackbar=s(G),this._configService=s(j),this._reportsService=s(L),this._sessionService=s(I),this._user=this._sessionService.loggedInUser,this.summary=u({expenses:0,pnl:0,reservations:0,revenues:0,unpaid:0}),this.selectedYears=u([new Date().getFullYear()-1,new Date().getFullYear()]),this.benchmark$=this._reportsService.benchmark$,this.combinedChart=new _,this.summaryGridRefresh=new k}ngOnInit(){this._navService.updateNav({show:!0,back:!1,title:N.LAYOUT.children.REPORTS.children.BENCHMARK.name,buttons:[{label:{text:"Change Years"},prefixIcon:{icon:"icon_calendar"},onClick:()=>this._changeYears()},{label:{text:"Download Excel"},prefixIcon:{icon:"icon_excel"},onClick:()=>this._saveExcel(),hide:!this._user?.admin}]}),this._initGrid()}ngAfterViewInit(){this._getBenchmark(),this.benchmark$.pipe(D(this._destroyRef)).subscribe(n=>{n&&this._reflectBenchmark(n)})}_changeYears(){let n={title:{text:"Change Years"},form:{value:{from:this.selectedYears()[0]??0,to:this.selectedYears()[this.selectedYears().length-1]},fields:[{label:{text:"From Year"},required:!0,name:"from",type:"number",integer:!0,disableNegativeValues:!0,range:{max:"to"}},{label:{text:"To Year"},required:!0,name:"to",type:"number",integer:!0,disableNegativeValues:!0,range:{min:"from"}}]},beforeCloseObservable:e=>e.from&&e.to&&Math.abs(e.from-e.to)>4?(this._snackbar.open({text:"Maximum allowed year gap is 5 year."},"error"),f(()=>"")):e.from!==void 0&&e.to!==void 0&&e.from>=e.to?(this._snackbar.open({text:"From year should be smaller than to year."},"error"),f(()=>"")):S(e)};this._dialog.openFormPopup(n,"500px").afterClosed().pipe(v(1)).subscribe(e=>{if(e){let{from:t,to:o}=e,r=o-t,l=Array.from({length:r+1},(Q,V)=>t+V);this.selectedYears.set(l),this._getBenchmark()}})}_getBenchmark(){this._reportsService.getBenchmarkReport(this.selectedYears())}_reflectBenchmark(n){let{benchmark:e,summary:t}=n,o=e.map(r=>({year:r.year,pnl:r.pnl,revenues:r.totalRevenues,expenses:r.totalExpenses,unpaid:r.totalUnpaidAmount,reservations:r.totalReservations}));this.summaryGridRefresh.next({data:o}),this.summary.set(o.reduce((r,l)=>(r.expenses+=l.expenses,r.pnl+=l.pnl,r.reservations+=l.reservations,r.revenues+=l.revenues,r.unpaid+=l.unpaid,r),{expenses:0,pnl:0,reservations:0,revenues:0,unpaid:0})),this._drawCharts(t)}_drawCharts(n){let e=n.pnlTrend.map(t=>t.year.toString());this.combinedChart=new _({title:{text:"Benchmark Overview"},credits:{enabled:!1},xAxis:[{categories:e,crosshair:!0,title:{text:"Year"}}],yAxis:[{labels:{format:"${value}",style:{color:"#007bff"}},title:{text:"Amount ($)",style:{color:"#007bff"}}},{title:{text:"Reservations (count)",style:{color:"#28a745"}},labels:{format:"{value}",style:{color:"#28a745"}},opposite:!0}],tooltip:{shared:!0},legend:{align:"center",verticalAlign:"bottom"},series:[{type:"spline",name:"Revenues",data:n.revenueTrend.map(t=>t.totalRevenues??null),color:"#007bff",yAxis:0},{type:"spline",name:"Expenses",data:n.expenseTrend.map(t=>t.totalExpenses??null),color:"#dc3545",yAxis:0},{type:"spline",name:"PnL",data:n.pnlTrend.map(t=>t.pnl??null),color:"#ffc107",yAxis:0,marker:{enabled:!0}},{type:"spline",name:"Unpaid Amount",data:n.unpaidTrend.map(t=>t.totalUnpaidAmount??null),color:"#6f42c1",dashStyle:"ShortDot",yAxis:0},{type:"spline",name:"Reservations",data:n.reservationsTrend.map(t=>t.totalReservations??null),color:"#28a745",yAxis:1}]})}_initGrid(){this.summaryGridConfig={data:u([]),hidePagination:!0,showFooter:!0,maxTableHeight:this._configService.appConfig.maxTableHeightWithSearch,columns:[{field:"year",title:"Year",type:"number",setFooterContentFn:()=>"Total"},{field:"reservations",title:"Reservations",type:"number",setFooterContentFn:()=>this.summary()?.reservations},{field:"revenues",title:"Total Revenues",type:"number",prefix:"$ ",setFooterContentFn:()=>"$ "+this.summary()?.revenues},{field:"expenses",title:"Total Expenses",type:"number",prefix:"$ ",setFooterContentFn:()=>"$ "+this.summary()?.expenses},{field:"unpaid",title:"Unpaid Amount",type:"number",prefix:"$ ",setFooterContentFn:()=>"$ "+this.summary()?.unpaid},{field:"pnl",title:"Profit / Loss",type:"number",prefix:"$ ",setFooterContentFn:()=>"$ "+this.summary()?.pnl}]}}_saveExcel(){this.benchmark$.pipe(v(1)).subscribe(n=>{n&&this._excelService.createExcelReport({reportTitle:"Benchmark Report",reportTimeFrame:this.selectedYears().join(", "),fields:["Benchmark Summary by Year"],sheets:[{columns:this.summaryGridConfig?.columns||[],data:n.benchmark.map(e=>({year:e.year,pnl:e.pnl,revenues:e.totalRevenues,expenses:e.totalExpenses,unpaid:e.totalUnpaidAmount,reservations:e.totalReservations})),title:"Benchmark Summary"}]},this._user?.name||"")})}};a.\u0275fac=function(e){return new(e||a)},a.\u0275cmp=R({type:a,selectors:[["ks-solutions-benchmark-report"]],standalone:!0,features:[Y([C]),A],decls:8,vars:9,consts:[[1,"container-fluid","mt-3","text-center"],[3,"config"],[1,"container-fluid"],[1,"mt-4"],[3,"config","refresh$"],[1,"one","cs-shadow","mt-4",3,"chart"]],template:function(e,t){if(e&1&&(y(0,"div",0),c(1,"ks-base-label",1),h(),y(2,"div",2)(3,"div",3),c(4,"ks-base-label",1),x(5,z,1,2,"ks-basic-grid",4),h(),x(6,J,1,1,"div",5),$(7,"async"),h()),e&2){let o;m(),p("config",w(6,q,"Report For "+t.selectedYears().join(" "))),m(3),p("config",T(8,W)),m(),g(t.summaryGridConfig?5:-1),m(),g((o=B(7,4,t.benchmark$))?6:-1,o)}},dependencies:[K,H,U,M,E],styles:[".cs-charts[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}@media (max-width: 850px){.cs-charts[_ngcontent-%COMP%]{grid-template-columns:1fr}}"],changeDetection:0});let i=a;return i})();export{he as ReportBenchmarkComponent};
